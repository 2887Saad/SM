<!DOCTYPE html>
<html class="loading semi-dark-layout" lang="en" data-layout="semi-dark-layout" data-textdirection="ltr">
<!-- BEGIN: Head-->

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=0,minimal-ui">
    <meta name="description"
        content="Vuexy admin is super flexible, powerful, clean &amp; modern responsive bootstrap 4 admin template with unlimited possibilities.">
    <meta name="keywords"
        content="admin template, Vuexy admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="PIXINVENT">
    <title>Layout Empty - Vuexy - Bootstrap HTML admin template</title>
    <link rel="apple-touch-icon" href="../../../app-assets/images/ico/apple-icon-120.png">
    <link rel="shortcut icon" type="image/x-icon" href="../../../app-assets/images/ico/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;1,400;1,500;1,600"
        rel="stylesheet">

    <!-- BEGIN: Vendor CSS-->
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/vendors.min.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/pickers/pickadate/pickadate.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/pickers/flatpickr/flatpickr.min.css">
    <!-- END: Vendor CSS-->

    <!-- BEGIN: Theme CSS-->
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/bootstrap-extended.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/colors.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/components.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/themes/dark-layout.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/themes/bordered-layout.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/themes/semi-dark-layout.css">

    <!-- BEGIN: Page CSS-->
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/plugins/forms/pickers/form-pickadate.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/core/menu/menu-types/vertical-menu.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/pages/modal-create-app.css">
    <!-- END: Page CSS-->

    <!-- BEGIN: Custom CSS-->
    <link rel="stylesheet" type="text/css" href="../../../assets/css/style.css">
    <!-- END: Custom CSS-->

</head>
<!-- END: Head-->

<!-- BEGIN: Body-->

<body class="vertical-layout vertical-menu-modern  navbar-floating footer-static  " data-open="click"
    data-menu="vertical-menu-modern" data-col="">
    <!-- BEGIN: Content-->

    <div class="app-content content ">
        <div class="content-overlay"></div>
        <div class="header-navbar-shadow"></div>
        <div class="content-wrapper container-xxl p-0">
            <div class="content-header row">
                <div class="content-header-left col-md-9 col-12 mb-2">
                    <div class="row breadcrumbs-top">
                        <div class="col-12">
                            <h2 class="content- header-title float-start mb-0">Invoice</h2>
                            <div class="breadcrumb-wrapper">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a>
                                    </li>
                                    <li class="breadcrumb-item">Add
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-body">
                <section id="basic-horizontal-layouts">
                    <div class="row">
                        <div class="col-12 align-items-center">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">Create Invoice</h4>
                                </div>
                                <div class="card-body">
                                    <!-- ===================== FBR Digital Invoice Form (Full Fields Based on JSON) ===================== -->
                                    <form id="fbrInvoiceForm">
                                        <div class="row mb-2">
                                            <!-- Invoice Type -->
                                            <!-- Web method for Digital Invoicing – Document Type -->
                                            <div class="col-6 col-md-6">
                                                <label class="form-label" for="invoiceType">Invoice Type
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="invoiceType" name="invoiceType">
                                                    <option value="Sale Invoice">Sale Invoice</option>
                                                    <option value="Credit Note">Credit Note</option>
                                                </select>
                                            </div>
                                            <!-- Invoice Date -->
                                            <div class="col-6 col-md-6 position-relative">
                                                <label class="form-label" for="pd-months-year">Invoice Date
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <input type="text" id="pd-months-year" class="form-control pickadate"
                                                    name="invoiceDate" placeholder="18 June, 2020" />
                                            </div>
                                            <!-- Invoice Ref No & Scenario -->
                                            <div class="col-xl-6 col-md-6 col-12">
                                                <label class="form-label" for="invoiceRefNo">Invoice Ref No</label>
                                                <input type="text" class="form-control" id="invoiceRefNo"
                                                    name="invoiceRefNo" />
                                            </div>
                                            <div class="col-xl-6 col-md-6 col-12">
                                                <label class="form-label" for="scenarioId">Scenario ID</label>
                                                <input type="text" class="form-control" id="scenarioId"
                                                    name="scenarioId" value="SN001" />
                                            </div>
                                            <div class="col-xl-6 col-md-6 col-12">
                                                <label class="form-label">Sale Type
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="saleType" name="saleType">
                                                    <option value="">-- Select Sale Type --
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <!-- Seller Details -->
                                            <div class="col-12">
                                                <h5>Seller Information</h5>
                                            </div>
                                            <div class="col-xl-4 col-md-6 col-12">
                                                <label class="form-label" for="sellerNTN">Seller NTN/CNIC
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="sellerNTN"
                                                    name="sellerNTNCNIC" />
                                            </div>
                                            <div class="col-xl-4 col-md-6 col-12">
                                                <label class="form-label" for="sellerName">Business Name
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="sellerName"
                                                    name="sellerBusinessName" />
                                            </div>
                                            <!-- Web method for Digital Invoicing – Province Code -->
                                            <div class="col-xl-4 col-md-6 col-12">
                                                <label class="form-label" for="sellerProvince">Province
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="sellerProvince" name="sellerProvince">
                                                </select>
                                            </div>
                                            <div class="col-12 col-xl-12 col-md-6">
                                                <label class="form-label" for="sellerAddress">Address
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="sellerAddress"
                                                    name="sellerAddress" />
                                            </div>
                                        </div>
                                        <div class="row">
                                            <!-- Buyer Details -->
                                            <div class="col-12">
                                                <h5>Buyer Information</h5>
                                            </div>
                                            <div class="col-xl-4 col-md-6 col-12">
                                                <label class="form-label" for="buyerRegistrationType">Registration Type
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="buyerRegistrationType"
                                                    name="buyerRegistrationType">
                                                    <option value="Registered">Registered</option>
                                                    <option value="Unregistered">Unregistered</option>
                                                </select>
                                            </div>
                                            <div class="col-xl-4 col-md-6 col-12">
                                                <label class="form-label" for="buyerNTN">Buyer NTN/CNIC
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="buyerNTN"
                                                    name="buyerNTNCNIC" />
                                            </div>
                                            <div class="col-xl-4 col-md-6 col-12">
                                                <label class="form-label" for="buyerName">Business Name
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="buyerName"
                                                    name="buyerBusinessName" />
                                            </div>
                                            <!-- Web method for Digital Invoicing – Province Code -->
                                            <div class="col-xl-4 col-md-6 col-12">
                                                <label class="form-label" for="buyerProvince">Province
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="buyerProvince" name="buyerProvince">
                                                </select>
                                            </div>
                                            <div class="col-8">
                                                <label class="form-label" for="buyerAddress">Address
                                                    <span class="required-star text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="buyerAddress"
                                                    name="buyerAddress" />
                                            </div>
                                        </div>
                                        <!-- button to add new button -->
                                        <div class="row">
                                            <div class="col-12 mt-2">
                                                <button class="btn btn-primary" type="button" data-bs-toggle="modal"
                                                    data-bs-target="#addNewItemModal">
                                                    <i data-feather="plus"></i> Add Item
                                                </button>
                                            </div>
                                        </div>
                                        <!--/ button to add new button -->
                                        <div class="row" id="table-responsive">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h4 class="card-title">Items Added</h4>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="table-responsive">
                                                            <table class="table mb-0" id="itemsTable">
                                                                <thead>
                                                                    <tr>
                                                                        <th>#</th>
                                                                        <th>HS Code</th>
                                                                        <th>Rate (%)</th>
                                                                        <th>UOM</th>
                                                                        <th>Qty</th>
                                                                        <th>Total Value Inc. ST</th>
                                                                        <th>Sales Excl. ST</th>
                                                                        <th>ST Applicable</th>
                                                                        <th>Further Tax</th>
                                                                        <th>FED Payable</th>
                                                                        <th>Discount</th>
                                                                        <th>Total Value</th>
                                                                        <th>SRO No.</th>
                                                                        <th>SRO Serial No.</th>
                                                                        <th>Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Invoice Items -->
                                        <!-- add new address modal -->
                                        <div class="modal fade" id="addNewItemModal" tabindex="-1"
                                            aria-labelledby="addNewItemTitle" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-transparent">
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body pb-5 px-sm-4 mx-50">
                                                        <h1 class="address-title text-center mb-1" id="addNewItemTitle">
                                                            Add New Item</h1>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label class="form-label">HS Code</label>
                                                                <select class="form-select" id="hsCode" name="hsCode">
                                                                    <option value="">-- Select HS Code --
                                                                    </option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Product
                                                                    Description</label>
                                                                <input type="text" class="form-control"
                                                                    id="productDescription" name="productDescription"
                                                                    readonly />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Rate (%)</label>
                                                                <select class="form-select" id="rateSelect"
                                                                    name="rateSelect">
                                                                    <option value="">-- Select Rate --</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">UOM</label>
                                                                <select class="form-select" id="uom" name="uoM">
                                                                    <option value="">-- Select UOM --</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Quantity</label>
                                                                <input type="number" class="form-control"
                                                                    name="quantity" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Total Value Inc. ST</label>
                                                                <input type="number" class="form-control"
                                                                    name="totalValueIncST"/>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Sales Value Excl. ST</label>
                                                                <input type="number" class="form-control"
                                                                    name="valueSalesExcludingST" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">ST Applicable</label>
                                                                <input type="number" class="form-control"
                                                                    name="salesTaxApplicable" readonly />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Further Tax</label>
                                                                <input type="number" class="form-control"
                                                                    name="furtherTax" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">FED Payable</label>
                                                                <input type="number" class="form-control"
                                                                    name="fedPayable" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Discount</label>
                                                                <input type="number" class="form-control"
                                                                    name="discount" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Fixed/Retail
                                                                    Price</label>
                                                                <input type="number" class="form-control"
                                                                    name="fixedNotifiedValueOrRetailPrice" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Total Values</label>
                                                                <input type="number" class="form-control"
                                                                    name="totalValues" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Tax Withheld</label>
                                                                <input type="number" class="form-control"
                                                                    name="salesTaxWithheldAtSource" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Extra Tax</label>
                                                                <input type="text" class="form-control"
                                                                    name="extraTax" />
                                                            </div>
                                                            <!-- ========== SRO Schedule (SRO No) ========== -->
                                                            <div class="col-md-6">
                                                                <label class="form-label">SRO No.</label>
                                                                <select class="form-select" id="sroScheduleNo"
                                                                    name="sroScheduleNo">
                                                                    <option value="">-- Select SRO --</option>
                                                                </select>
                                                            </div>
                                                            <!-- ========== SRO Serial No ========== -->
                                                            <div class="col-md-6">
                                                                <label class="form-label">SRO Serial No.</label>
                                                                <select class="form-select" id="sroItemSerialNo"
                                                                    name="sroItemSerialNo">
                                                                    <option value="">-- Select SRO Item --
                                                                    </option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-12 text-center">
                                                            <button type="submit" class="btn btn-primary me-1 mt-2"
                                                                id="submitModalData">Submit</button>
                                                            <button type="reset" class="btn btn-outline-secondary mt-2"
                                                                data-bs-dismiss="modal" aria-label="Close">
                                                                Discard
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Submit Button -->
                                        <div class="col-12 mt-2">
                                            <button class="btn btn-success" type="submit">Submit Invoice</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <!-- END: Content-->

    <div class="sidenav-overlay"></div>
    <div class="drag-target"></div>

    <!-- BEGIN: Footer-->
    <footer class="footer footer-static footer-light">
        <p class="clearfix mb-0"><span class="float-md-start d-block d-md-inline-block mt-25">COPYRIGHT &copy; 2021<a
                    class="ms-25" href="https://1.envato.market/pixinvent_portfolio" target="_blank">Pixinvent</a><span
                    class="d-none d-sm-inline-block">, All rights Reserved</span></span><span
                class="float-md-end d-none d-md-block">Hand-crafted & Made with<i data-feather="heart"></i></span></p>
    </footer>
    <button class="btn btn-primary btn-icon scroll-top" type="button"><i data-feather="arrow-up"></i></button>
    <!-- END: Footer-->


    <!-- BEGIN: Vendor JS-->
    <script src="../../../app-assets/vendors/js/vendors.min.js"></script>
    <script src="../../../app-assets/vendors/js/pickers/pickadate/picker.js"></script>
    <script src="../../../app-assets/vendors/js/pickers/pickadate/picker.date.js"></script>
    <script src="../../../app-assets/vendors/js/pickers/pickadate/picker.time.js"></script>
    <script src="../../../app-assets/vendors/js/pickers/pickadate/legacy.js"></script>
    <script src="../../../app-assets/vendors/js/pickers/flatpickr/flatpickr.min.js"></script>
    <!-- script for modal -->
    <script src="../../../app-assets/js/scripts/pages/modal-add-new-address.js"></script>

    <!-- BEGIN Vendor JS-->

    <!-- BEGIN: Page Vendor JS-->

    <!-- END: Page Vendor JS-->

    <!-- BEGIN: Theme JS-->
    <script src="../../../app-assets/js/core/app-menu.js"></script>
    <script src="../../../app-assets/js/core/app.js"></script>
    <!-- END: Theme JS-->

    <!-- BEGIN: Page JS-->
    <script src="../../../app-assets/js/scripts/forms/pickers/form-pickers.js"></script>
    <!-- END: Page JS-->

    <script>
        $(window).on('load', function () {
            if (feather) {
                feather.replace({
                    width: 14,
                    height: 14
                });
            }
        })
    </script>

    <!-- HS Code auto-load and description handling -->
    <script>
        const API_HEADERS = {
            "Authorization": "Bearer d3d66378-1952-3a38-93a0-0403bd704983",
            "Content-Type": "application/json"
        };

        // 🧩 Utility — Convert yyyy-mm-dd → 24-FEB-2025 format
        function formatDateForApi(inputDate) {
            if (!inputDate) return "";
            const date = new Date(inputDate);
            const day = String(date.getDate()).padStart(2, "0");
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // 1️⃣ Load HS Codes
        async function loadHsCodes() {
            const select = document.getElementById("hsCode");
            try {
                const response = await fetch("https://gw.fbr.gov.pk/pdi/v1/itemdesccode", {
                    headers: API_HEADERS
                });
                if (!response.ok) throw new Error("Failed to fetch HS Codes");
                const data = await response.json();
                select.length = 1;
                data.forEach(item => {
                    const option = document.createElement("option");
                    option.value = item.hS_CODE;
                    option.textContent = `${item.hS_CODE} - ${item.description.split('-')[1]?.trim() || item.description}`;
                    option.dataset.description = item.description;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("Error loading HS Codes:", err);
            }
        }

        // 2️⃣ Load Sale Types
        async function loadSaleTypes() {
            const saleTypeSelect = document.getElementById("saleType");
            try {
                const response = await fetch("https://gw.fbr.gov.pk/pdi/v1/transtypecode", {
                    headers: API_HEADERS
                });
                if (!response.ok) throw new Error("Failed to fetch Sale Types");
                const data = await response.json();
                saleTypeSelect.length = 1;
                data.forEach(item => {
                    const option = document.createElement("option");
                    option.value = item.transactioN_DESC;
                    option.textContent = item.transactioN_DESC;
                    option.dataset.id = item.transactioN_TYPE_ID;
                    saleTypeSelect.appendChild(option);
                });
            } catch (err) {
                console.error("Error loading Sale Types:", err);
            }
        }

        // 3️⃣ Load Rates based on Sale Type + Date
        async function loadRates(transactionTypeId, invoiceDate) {
            const rateSelect = document.getElementById("rateSelect");
            if (!rateSelect) {
                console.error("Rate select element not found in DOM");
                return;
            }

            rateSelect.innerHTML = '<option value="">-- Loading Rates... --</option>';

            const formattedDate = formatDateForApi(invoiceDate);
            if (!formattedDate) {
                alert("Please select an Invoice Date first!");
                rateSelect.innerHTML = '<option value="">-- Select Rate --</option>';
                return;
            }

            const url = `https://gw.fbr.gov.pk/pdi/v2/SaleTypeToRate?date=${formattedDate}&transTypeId=${transactionTypeId}&originationSupplier=2`;

            try {
                const response = await fetch(url, { headers: API_HEADERS });

                if (!response.ok) throw new Error("Failed to fetch Rate Data");

                const data = await response.json();

                // Reset and populate
                rateSelect.innerHTML = '<option value="">-- Select Rate --</option>';
                data.forEach(rate => {
                    const option = document.createElement("option");
                    option.value = rate.ratE_DESC;              // shows "18%"
                    option.textContent = rate.ratE_DESC;        // display text as "18%"
                    option.dataset.id = rate.ratE_ID;           // store the ratE_ID for next API call
                    option.dataset.value = rate.ratE_VALUE;     // optional: store numeric value (18)
                    rateSelect.appendChild(option);
                });

            } catch (err) {
                console.error("Error loading rates:", err);
                rateSelect.innerHTML = '<option value="">-- Failed to Load Rates --</option>';
            }
        }
        ///////////////////////////
        async function loadUOM(hsCode) {
            try {
                const response = await fetch(`https://gw.fbr.gov.pk/pdi/v2/HS_UOM?hs_code=${hsCode}&annexure_id=3`, {
                    headers: API_HEADERS
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                const uomDropdown = document.getElementById("uom");
                uomDropdown.innerHTML = `<option value="">-- Select UOM --</option>`;

                data.forEach(uom => {
                    const option = document.createElement("option");
                    option.value = uom.uoM_ID;
                    option.textContent = uom.description;
                    uomDropdown.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading UOM:", error);
            }
        }
        // =====================================
        // 3️⃣ Load SRO Schedule (based on Rate)
        // =====================================
        async function loadSRO(rateId, dateInput) {
            try {
                const formattedDate = formatDateForApi(dateInput);
                if (!formattedDate) {
                    alert("Please select Invoice Date first.");
                    return;
                }

                const url = `https://gw.fbr.gov.pk/pdi/v1/SroSchedule?rate_id=${rateId}&date=${formattedDate}&origination_supplier_csv=2`;
                const response = await fetch(url, {
                    headers: API_HEADERS
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                const sroDropdown = document.getElementById("sroScheduleNo");
                sroDropdown.innerHTML = `<option value="">-- Select SRO --</option>`;
                data.forEach(sro => {
                    const option = document.createElement("option");
                    option.value = sro.srO_ID; // store ID for next call
                    option.textContent = sro.srO_DESC; // visible text
                    sroDropdown.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading SRO:", error);
            }
        }

        // =====================================
        // 4️⃣ Load SRO Item (based on SRO ID)
        // =====================================
        async function loadSROItem(sroId, dateInput) {
            try {
                const formattedDate = formatDateForApi(dateInput);
                if (!formattedDate) {
                    alert("Please select Invoice Date first.");
                    return;
                }

                // date format for this API must be YYYY-MM-DD (e.g., 2025-02-10)
                const isoDate = new Date(dateInput).toISOString().split("T")[0];
                const url = `https://gw.fbr.gov.pk/pdi/v2/SROItem?date=${isoDate}&sro_id=${sroId}`;
                const response = await fetch(url, {
                    headers: API_HEADERS
                });
                const data = await response.json();
                const sroItemDropdown = document.getElementById("sroItemSerialNo");
                sroItemDropdown.innerHTML = `<option value="">-- Select SRO Item --</option>`;
                data.forEach(item => {
                    const option = document.createElement("option");
                    option.value = item.srO_ITEM_DESC;
                    option.textContent = item.srO_ITEM_DESC;
                    sroItemDropdown.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading SRO Items:", error);
            }
        }


        // 4️⃣ Event Listeners
        document.getElementById("hsCode").addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            document.getElementById("productDescription").value = selectedOption.dataset.description || "";
        });

        document.getElementById("saleType").addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const transactionTypeId = selectedOption.dataset.id;
            const invoiceDate = document.getElementById("pd-months-year").value;

            if (transactionTypeId && invoiceDate) {
                loadRates(transactionTypeId, invoiceDate);
            } else if (!invoiceDate) {
                alert("Please select an invoice date before choosing Sale Type.");
                this.value = "";
            }
        });
        document.getElementById("hsCode").addEventListener("change", function () {
            const hsCode = this.value.trim();
            if (hsCode) loadUOM(hsCode);
        });
        document.getElementById("rateSelect").addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const rateId = selectedOption.getAttribute('data-id');
            const dateInput = document.getElementById("pd-months-year").value;
            if (rateId) loadSRO(rateId, dateInput);
        });

        document.getElementById("sroScheduleNo").addEventListener("change", function () {
            const sroId = this.value;
            const dateInput = document.getElementById("pd-months-year").value;
            if (sroId) loadSROItem(sroId, dateInput);
        });


        // ====== New: Load provinces for sellerProvince & buyerProvince ======
        async function loadProvinces() {
            const url = "https://gw.fbr.gov.pk/pdi/v1/provinces";
            const seller = document.getElementById("sellerProvince");
            const buyer = document.getElementById("buyerProvince");
            if (!seller && !buyer) return;

            try {
                const resp = await fetch(url, { headers: API_HEADERS });
                if (!resp.ok) throw new Error("Failed to fetch provinces");
                const data = await resp.json();

                const defaultOpt = '<option value="">-- Select Province --</option>';
                if (seller) seller.innerHTML = defaultOpt;
                if (buyer) buyer.innerHTML = defaultOpt;

                (data || []).forEach(item => {
                    const text = item.stateProvinceDesc;
                    const code = item.stateProvinceCode;

                    // seller option
                    if (seller) {
                        const opt = document.createElement("option");
                        opt.value = text;
                        opt.textContent = text;
                        opt.dataset.code = code; // store code on option
                        seller.appendChild(opt);
                    }

                    // buyer option (create separate node)
                    if (buyer) {
                        const opt2 = document.createElement("option");
                        opt2.value = text;
                        opt2.textContent = text;
                        opt2.dataset.code = code;
                        buyer.appendChild(opt2);
                    }
                });
            } catch (err) {
                console.error("Error loading provinces:", err);
            }
        }

        // when user selects a province, copy the selected option's code to the select.dataset.code
        function attachProvinceSelectListener(selectId) {
            const el = document.getElementById(selectId);
            if (!el) return;
            el.addEventListener("change", function () {
                const sel = this.options[this.selectedIndex];
                this.dataset.code = sel ? (sel.dataset.code || "") : "";
            });
        }

        // ensure provinces load on DOM ready with other data
        document.addEventListener("DOMContentLoaded", () => {
            loadHsCodes();
            loadSaleTypes();
            loadProvinces();
            attachProvinceSelectListener("sellerProvince");
            attachProvinceSelectListener("buyerProvince");
            loadInvoiceTypes();
            attachInvoiceTypeListener();
        });

        // Simple: load Invoice Types into #invoiceType, set option value/text = docDescription,
        // store docTypeId on each option as data-id, and copy selected option's id to select.dataset.id

        function escapeHtml(s) { return String(s || "").replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
        async function loadInvoiceTypes() {
            const API = "https://gw.fbr.gov.pk/pdi/v1/doctypecode";
            const sel = document.getElementById("invoiceType");
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Select Invoice Type --</option>';
            try {
                const resp = await fetch(API, { headers: API_HEADERS });
                const list = await resp.json();
                // let list = Array.isArray(data) ? data : (data && Array.isArray(data.data) ? data.data : []);
                // if (!list.length && typeof data === 'object') {
                //     for (const k in data) if (Array.isArray(data[k])) { list = data[k]; break; }
                // }
                list.forEach(item => {
                    const text = item.docDescription || "";
                    const id = item.docTypeId ?? "";
                    const opt = document.createElement("option");
                    opt.value = escapeHtml(text);
                    opt.textContent = text;
                    if (id !== "") opt.dataset.id = id;
                    sel.appendChild(opt);
                });
            } catch (err) {
                console.error("Failed to load invoice types:", err);
            }
        }

        function attachInvoiceTypeListener() {
            const sel = document.getElementById("invoiceType");
            if (!sel) return;
            sel.addEventListener("change", function () {
                const opt = this.options[this.selectedIndex];
                this.dataset.id = opt ? (opt.dataset.id || "") : "";
            });
        }
        // ...existing code...
        document.addEventListener('DOMContentLoaded', () => {
            const modalEl = document.getElementById('addNewItemModal');
            const submitBtn = document.getElementById('submitModalData');
            const tableBody = document.querySelector('#itemsTable tbody');

            if (!modalEl || !submitBtn || !tableBody) return;

            // ====== Sale type -> required fields mapping ======
            const saleTypeRequirements = {
                "75": ["hsCode", "rateSelect", "uom", "quantity", "salesTaxApplicable"],
                "24": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "80": ["hsCode", "rateSelect", "uom", "salesTaxApplicable", "sroScheduleNo", "sroItemSerialNo"],
                "85": ["hsCode", "rateSelect", "uom", "quantity", "salesTaxApplicable"],
                "62": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "129": ["hsCode", "rateSelect", "uom", "quantity", "sroScheduleNo", "sroItemSerialNo"],
                "77": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "122": ["hsCode", "rateSelect", "uom"],
                "25": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "23": ["hsCode", "rateSelect", "uom", "salesTaxApplicable", "fixedNotifiedValueOrRetailPrice"],
                "21": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "22": ["hsCode", "rateSelect", "salesTaxApplicable"],
                "18": ["hsCode", "rateSelect", "salesTaxApplicable"],
                "81": ["hsCode", "rateSelect", "uom", "salesTaxApplicable", "sroScheduleNo", "sroItemSerialNo"],
                "82": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "130": ["hsCode", "rateSelect", "uom", "salesTaxApplicable", "salesTaxWithheldAtSource"],
                "132": ["hsCode", "rateSelect", "uom", "salesTaxApplicable", "sroScheduleNo", "sroItemSerialNo"],
                "134": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "84": ["hsCode", "rateSelect", "salesTaxApplicable"],
                "123": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "125": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "115": ["hsCode", "rateSelect", "uom", "quantity", "sroScheduleNo", "sroItemSerialNo"], // special note in prompt kept same
                "178": ["hsCode", "rateSelect", "uom", "quantity", "salesTaxApplicable", "sroScheduleNo", "sroItemSerialNo"],
                "181": ["hsCode", "rateSelect", "uom", "salesTaxApplicable"],
                "138": ["hsCode", "rateSelect", "uom", "quantity", "salesTaxApplicable", "sroScheduleNo", "sroItemSerialNo"],
                "139": ["hsCode", "rateSelect", "uom", "quantity", "salesTaxApplicable", "sroScheduleNo", "sroItemSerialNo"]
            };

            // helper: find field inside modal by id or name
            function getModalField(field) {
                let el = modalEl.querySelector('#' + field);
                if (el) return el;
                return modalEl.querySelector('[name="' + field + '"]') || null;
            }

            // remove previous required stars
            function clearRequiredStars() {
                modalEl.querySelectorAll('.required-star').forEach(s => s.remove());
            }

            // add red * to labels of required fields
            function markRequiredFields(requiredList) {
                clearRequiredStars();
                requiredList.forEach(f => {
                    // prefer label[for=id]
                    const byId = modalEl.querySelector('label[for="' + f + '"]');
                    if (byId) {
                        if (!byId.querySelector('.required-star')) {
                            const star = document.createElement('span');
                            star.className = 'required-star text-danger';
                            star.textContent = '*';
                            byId.appendChild(star);
                        }
                        return;
                    }
                    // else try to locate label in same column
                    const fieldEl = getModalField(f);
                    if (!fieldEl) return;
                    const col = fieldEl.closest('.col-md-6, .col-6, .col-12, .col-xl-6');
                    if (!col) return;
                    const lbl = col.querySelector('label');
                    if (lbl && !lbl.querySelector('.required-star')) {
                        const star = document.createElement('span');
                        star.className = 'required-star text-danger';
                        star.textContent = '*';
                        lbl.appendChild(star);
                    }
                });
            }

            // clear invalid visuals
            function clearInvalids() {
                modalEl.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            }

            // validate modal fields according to sale type id
            function validateForSaleType(saleTypeId) {
                clearInvalids();
                const required = saleTypeRequirements[String(saleTypeId)] || [];
                const missing = [];
                required.forEach(f => {
                    const el = getModalField(f);
                    if (!el) {
                        missing.push(f);
                        return;
                    }
                    let val = '';
                    if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        val = el.value;
                    } else {
                        val = el.textContent || '';
                    }
                    // numeric fields: quantity and numeric inputs must be non-empty
                    if (f === 'quantity') {
                        if (val === '' || isNaN(Number(val)) || Number(val) <= 0) {
                            missing.push(f);
                            el.classList && el.classList.add('is-invalid');
                        }
                    } else {
                        if (String(val).trim() === '') {
                            missing.push(f);
                            el.classList && el.classList.add('is-invalid');
                        }
                    }
                });
                return { ok: missing.length === 0, missing };
            }

            // when modal opens, mark required fields based on selected sale type id
            function onModalShow() {
                const saleTypeSel = document.getElementById('saleType');
                const selected = saleTypeSel && saleTypeSel.options[saleTypeSel.selectedIndex];
                const saleTypeId = selected ? selected.dataset.id : (saleTypeSel ? saleTypeSel.dataset.id : '');
                if (saleTypeId && saleTypeRequirements[String(saleTypeId)]) {
                    markRequiredFields(saleTypeRequirements[String(saleTypeId)]);
                } else {
                    clearRequiredStars();
                }
                clearInvalids();
            }

            // attach Bootstrap modal show event if available, else fallback to button handler
            if (window.bootstrap && modalEl) {
                modalEl.addEventListener('show.bs.modal', onModalShow);
            } else {
                // fallback: when open button clicked, call onModalShow after tiny delay
                document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#addNewItemModal"]').forEach(btn => {
                    btn.addEventListener('click', function () { setTimeout(onModalShow, 50); });
                });
            }

             // Helper: read values from fields inside modal only
             function readModalValues() {
                 const q = (sel) => modalEl.querySelector(sel);
                 const hsSelect = q('#hsCode');
                 const rateSelect = q('#rateSelect');
                 const uomSelect = q('#uom');
                 const sroSelect = q('#sroScheduleNo');
                 const sroItemSelect = q('#sroItemSerialNo');
 
                 return {
                     hsCode: hsSelect ? hsSelect.value : '',
                     hsText: hsSelect ? (hsSelect.options[hsSelect.selectedIndex]?.text || '') : '',
                     description: (q('#productDescription') || {}).value || '',
                     saleType: (q('select[name="saleType"]') || {}).value || '',
                     rate: rateSelect ? (rateSelect.value || '') : '',
                     rateId: rateSelect ? (rateSelect.options[rateSelect.selectedIndex]?.dataset.id || '') : '',
                     uom: uomSelect ? (uomSelect.options[uomSelect.selectedIndex]?.text || uomSelect.value || '') : '',
                     totalValueIncST: (q('input[name="totalValueIncST"]') || {}).value || '',
                     quantity: (q('input[name="quantity"]') || {}).value || '',
                     salesExcl: (q('input[name="valueSalesExcludingST"]') || {}).value || '',
                     stApplicable: (q('input[name="salesTaxApplicable"]') || {}).value || '',
                     furtherTax: (q('input[name="furtherTax"]') || {}).value || '',
                     fedPayable: (q('input[name="fedPayable"]') || {}).value || '',
                     discount: (q('input[name="discount"]') || {}).value || '',
                     totalValues: (q('input[name="totalValues"]') || {}).value || '',
                     sroNo: sroSelect ? (sroSelect.options[sroSelect.selectedIndex]?.text || sroSelect.value || '') : '',
                     sroItem: sroItemSelect ? (sroItemSelect.options[sroItemSelect.selectedIndex]?.text || sroItemSelect.value || '') : ''
                 };
             }
 
             // Insert a row into the items table
             function addItemToTable(values) {
                 const rowCount = tableBody.querySelectorAll('tr').length;
                 const tr = document.createElement('tr');
 
                 tr.innerHTML = `
                 <td class="text-nowrap">${rowCount + 1}</td>
                 <td class="text-nowrap">${escapeHtml(values.hsCode || values.hsText)}</td>
                 <td class="text-nowrap">${escapeHtml(values.rate)}</td>
                 <td class="text-nowrap">${escapeHtml(values.uom)}</td>
                 <td class="text-nowrap">${escapeHtml(values.quantity)}</td>
                 <td class="text-nowrap">${escapeHtml(values.totalValueIncST)}</td>
                 <td class="text-nowrap">${escapeHtml(values.salesExcl)}</td>
                 <td class="text-nowrap">${escapeHtml(values.stApplicable)}</td>
                 <td class="text-nowrap">${escapeHtml(values.furtherTax)}</td>
                 <td class="text-nowrap">${escapeHtml(values.fedPayable)}</td>
                 <td class="text-nowrap">${escapeHtml(values.discount)}</td>
                 <td class="text-nowrap">${escapeHtml(values.totalValues)}</td>
                 <td class="text-nowrap">${escapeHtml(values.sroNo)}</td>
                 <td class="text-nowrap">${escapeHtml(values.sroItem)}</td>
                 <td class="text-nowrap">
                     <button type="button" class="btn btn-sm btn-danger btn-delete-item">Delete</button>
                 </td>
                 `;
 
                 // store raw data on row for later use if needed
                 tr.dataset.item = JSON.stringify(values);
                 tableBody.appendChild(tr);
             }
 
             // Simple html escape
             function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
 
             // Reset modal inputs (clears inputs & resets selects to first option)
             function resetModalFields() {
                 modalEl.querySelectorAll('input, select').forEach(el => {
                     if (el.tagName === 'INPUT') el.value = '';
                     if (el.tagName === 'SELECT') el.selectedIndex = 0;
                 });
                 // keep productDescription readonly empty too
                 const pd = modalEl.querySelector('#productDescription');
                 if (pd) pd.value = '';
                clearRequiredStars();
             }
 
             // Reindex the first column numbers
             function reindexTable() {
                 tableBody.querySelectorAll('tr').forEach((tr, i) => {
                     tr.cells[0].textContent = i + 1;
                 });
             }
 
             // Click handler for submit button in modal
             submitBtn.addEventListener('click', function (ev) {
                 ev.preventDefault();
                 ev.stopPropagation();
 
                // Check sale type requirements before reading values
                const saleTypeSel = document.getElementById('saleType');
                const selectedSaleOpt = saleTypeSel && saleTypeSel.options[saleTypeSel.selectedIndex];
                const saleTypeId = selectedSaleOpt ? selectedSaleOpt.dataset.id : (saleTypeSel ? saleTypeSel.dataset.id : '');
                if (saleTypeId) {
                    const check = validateForSaleType(saleTypeId);
                    if (!check.ok) {
                        alert('Please fill required fields: ' + check.missing.join(', '));
                        // focus first invalid
                        const first = modalEl.querySelector('.is-invalid');
                        if (first) first.focus();
                        return;
                    }
                }
 
                 const values = readModalValues();
 
                 addItemToTable(values);
                 reindexTable();
 
                 // hide modal using Bootstrap API (supports v5)
                 try {
                     const bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                     bsModal.hide();
                 } catch (e) {
                     // fallback to jQuery if available
                     if (window.jQuery) jQuery(modalEl).modal('hide');
                 }
 
                 // clear modal inputs for next use
                 resetModalFields();
             });
 
             // Delegate delete button clicks
             tableBody.addEventListener('click', function (ev) {
                 if (!ev.target) return;
                 if (ev.target.classList.contains('btn-delete-item')) {
                     const row = ev.target.closest('tr');
                     if (row) {
                         row.remove();
                         reindexTable();
                     }
                 }
             });
         });
    </script>
    <script>
(async function () {
  const POST_URL = "https://gw.fbr.gov.pk/di_data/v1/di/postinvoicedata_sb";
  const headers = Object.assign({ "Accept": "application/json" }, API_HEADERS);

  // helpers
  function isoDate(input) {
    if (!input) return "";
    const d = new Date(input);
    if (isNaN(d)) return "";
    return d.toISOString().split('T')[0];
  }

  function findFieldForLabelStar(starEl) {
    const lbl = starEl.closest('label') || starEl.parentElement;
    if (!lbl) return null;
    const id = lbl.getAttribute('for');
    if (id) return document.getElementById(id);
    const col = lbl.closest('.col-md-6, .col-6, .col-12, .col-xl-6, .col-xl-4');
    if (!col) return null;
    return col.querySelector('input,select,textarea');
  }

  function toNumber(v){ const n = Number(String(v || '').replace('%','').trim()); return isNaN(n)?0:n; }

  // map sale-type modal field name -> item object keys
  const itemFieldMap = {
    "hsCode": "hsCode",
    "rateSelect": "rate",
    "uom": "uom",
    "quantity": "quantity",
    "salesTaxApplicable": ["stApplicable","salesTaxApplicable"],
    "sroScheduleNo": "sroNo",
    "sroItemSerialNo": "sroItem",
    "fixedNotifiedValueOrRetailPrice": "fixedNotifiedValueOrRetailPrice",
    "salesTaxWithheldAtSource": "salesTaxWithheldAtSource"
  };

  function itemHasField(item, f) {
    const key = itemFieldMap[f];
    if (!key) return !!(item[f]); // fallback
    if (Array.isArray(key)) return key.some(k => String(item[k] || '').trim() !== '');
    return String(item[key] || '').trim() !== '';
  }

  // get saleTypeId by matching saleType text
  function getSaleTypeIdByText(text) {
    const sel = document.getElementById('saleType');
    if (!sel || !text) return "";
    for (let i=0;i<sel.options.length;i++){
      const o = sel.options[i];
      if ((o.textContent||'').trim() === String(text).trim()) return o.dataset.id || "";
    }
    return "";
  }

  // main submit handler
  const form = document.getElementById('fbrInvoiceForm');
  if (!form) return;

  form.addEventListener('submit', async function (ev) {
    // prevent default submission
    ev.preventDefault();

    // 1) Validate top-level required fields (labels that have .required-star inside the form)
    const requiredStars = Array.from(form.querySelectorAll('.required-star'));
    const missingTop = [];
    requiredStars.forEach(star => {
      const fld = findFieldForLabelStar(star);
      if (!fld) return; // can't validate if not found
      const val = (fld.value === undefined) ? (fld.textContent || '') : String(fld.value).trim();
      // invoiceRefNo and scenarioId are explicitly optional per your instruction
      if (fld.id === 'invoiceRefNo' || fld.id === 'scenarioId') return;
      if (val === '') {
        missingTop.push(fld.id || fld.name || (fld.tagName + ':' + (fld.id||fld.name)));
        fld.classList && fld.classList.add('is-invalid');
      } else {
        fld.classList && fld.classList.remove('is-invalid');
      }
    });

    if (missingTop.length) {
      alert('Please fill required fields: ' + missingTop.join(', '));
      (form.querySelector('.is-invalid') || form.querySelector('input,select,textarea')).focus();
      return;
    }

    // 2) Collect items from table and validate per-item
    const tableBody = document.querySelector('#itemsTable tbody');
    const rows = tableBody ? Array.from(tableBody.querySelectorAll('tr')) : [];
    if (!rows.length) {
      alert('Please add at least one item.');
      return;
    }

    const saleTypeReqs = {
      "75": ["hsCode","rateSelect","uom","quantity","salesTaxApplicable"],
      "24": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "80": ["hsCode","rateSelect","uom","salesTaxApplicable","sroScheduleNo","sroItemSerialNo"],
      "85": ["hsCode","rateSelect","uom","quantity","salesTaxApplicable"],
      "62": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "129": ["hsCode","rateSelect","uom","quantity","sroScheduleNo","sroItemSerialNo"],
      "77": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "122": ["hsCode","rateSelect","uom"],
      "25": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "23": ["hsCode","rateSelect","uom","salesTaxApplicable","fixedNotifiedValueOrRetailPrice"],
      "21": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "22": ["hsCode","rateSelect","salesTaxApplicable"],
      "18": ["hsCode","rateSelect","salesTaxApplicable"],
      "81": ["hsCode","rateSelect","uom","salesTaxApplicable","sroScheduleNo","sroItemSerialNo"],
      "82": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "130": ["hsCode","rateSelect","uom","salesTaxApplicable","salesTaxWithheldAtSource"],
      "132": ["hsCode","rateSelect","uom","salesTaxApplicable","sroScheduleNo","sroItemSerialNo"],
      "134": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "84": ["hsCode","rateSelect","salesTaxApplicable"],
      "123": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "125": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "115": ["hsCode","rateSelect","uom","quantity","sroScheduleNo","sroItemSerialNo"],
      "178": ["hsCode","rateSelect","uom","quantity","salesTaxApplicable","sroScheduleNo","sroItemSerialNo"],
      "181": ["hsCode","rateSelect","uom","salesTaxApplicable"],
      "138": ["hsCode","rateSelect","uom","quantity","salesTaxApplicable","sroScheduleNo","sroItemSerialNo"],
      "139": ["hsCode","rateSelect","uom","quantity","salesTaxApplicable","sroScheduleNo","sroItemSerialNo"]
    };

    const items = [];
    const itemErrors = [];

    rows.forEach((tr, idx) => {
      let obj = {};
      try { obj = JSON.parse(tr.dataset.item || '{}'); } catch(e) { obj = {}; }
      // determine saleTypeId for this item by matching saleType text to select options
      const saleTypeId = getSaleTypeIdByText(obj.saleType || '') || '';
      const reqs = saleTypeReqs[String(saleTypeId)] || [];

      // for each required field ensure present
      const missing = [];
      reqs.forEach(f => {
        if (!itemHasField(obj, f)) missing.push(f);
      });

      // always require hsCode and rate at minimum
      if (!String(obj.hsCode || obj.hsText || '').trim()) missing.push('hsCode');
      if (!String(obj.rate || '').trim()) missing.push('rate');

      if (missing.length) itemErrors.push(`Item ${idx+1}: missing ${[...new Set(missing)].join(', ')}`);

      // normalize to final keys expected by API
      items.push({
        hsCode: obj.hsCode || obj.hsText || '',
        productDescription: obj.description || '',
        rate: obj.rate || '',
        uoM: obj.uom || obj.uoM || '',
        quantity: Number(obj.quantity) || 0,
        totalValues: Number(obj.totalValues) || 0,
        valueSalesExcludingST: Number(obj.salesExcl || obj.valueSalesExcludingST) || 0,
        fixedNotifiedValueOrRetailPrice: Number(obj.fixedNotifiedValueOrRetailPrice) || 0,
        salesTaxApplicable: Number(obj.stApplicable || obj.salesTaxApplicable) || 0,
        salesTaxWithheldAtSource: Number(obj.salesTaxWithheldAtSource) || 0,
        extraTax: obj.extraTax || '',
        furtherTax: Number(obj.furtherTax) || 0,
        sroScheduleNo: obj.sroNo || '',
        fedPayable: Number(obj.fedPayable) || 0,
        discount: Number(obj.discount) || 0,
        saleType: obj.saleType || '',
        sroItemSerialNo: obj.sroItem || ''
      });
    });

    if (itemErrors.length) {
      alert('Fix item errors:\n' + itemErrors.join('\n'));
      return;
    }

    // 3) Prepare payload
    const payload = {
      invoiceType: (document.getElementById('invoiceType') || {}).value || '',
      invoiceDate: isoDate((document.getElementById('pd-months-year') || {}).value) || '',
      sellerNTNCNIC: (document.getElementById('sellerNTN') || {}).value || '',
      sellerBusinessName: (document.getElementById('sellerName') || {}).value || '',
      sellerProvince: (document.getElementById('sellerProvince') || {}).value || '',
      sellerAddress: (document.getElementById('sellerAddress') || {}).value || '',
      buyerNTNCNIC: (document.getElementById('buyerNTN') || {}).value || '',
      buyerBusinessName: (document.getElementById('buyerName') || {}).value || '',
      buyerProvince: (document.getElementById('buyerProvince') || {}).value || '',
      buyerAddress: (document.getElementById('buyerAddress') || {}).value || '',
      buyerRegistrationType: (document.getElementById('buyerRegistrationType') || {}).value || '',
      invoiceRefNo: (document.getElementById('invoiceRefNo') || {}).value || '',
      scenarioId: (document.getElementById('scenarioId') || {}).value || '',
      items: items
    };

    // 4) POST to API
    try {
      const resp = await fetch(POST_URL, {
        method: 'POST',
        headers: Object.assign({}, headers, { "Content-Type": "application/json" }),
        body: JSON.stringify(payload)
      });
      const respBody = await resp.json().catch(()=>null);
      if (resp.ok) {
        alert('Invoice submitted successfully.');
        // optional: clear form or redirect
        // form.reset();
      } else {
        console.error('Submission failed', resp.status, respBody);
        alert('Submission failed: ' + (respBody?.message || JSON.stringify(respBody) || resp.status));
      }
    } catch (err) {
      console.error('Network error', err);
      alert('Network error while submitting invoice.');
    }
  });

})();
</script>

</body>
<!-- END: Body-->

</html>